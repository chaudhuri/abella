<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Testing document</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css" />
</head>

<body>
  <div class="absolute inset-0">
    <div id="thmbox" class="font-mono bg-yellow-200 w-full h-full px-5 whitespace-pre overflow-auto">
      Hello, world
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>
  <script>
    let thm_file = "";
    const seqToStr = (obj) => {
      let repr = '<div class="grid grid-col whitespace-normal ml-2 pl-2 border-l-2 border-l-rose-200">';
      if (obj.name && obj.name.length > 0) {
        repr += `<div><span class="mb-3 bg-rose-400 text-slate-100 p-1 font-sans text-xs">Subgoal: ${obj.name}</span></div>`;
      }
      if (obj.vars && obj.vars.length > 0) {
        repr += `<div><code>Variables: ${obj.vars.join(" ")}</code></div>`;
      }
      obj.hyps.forEach((h) => {
        repr += `<div><code>${h[0]}: ${h[1]}</code></div>`;
      });
      repr += `<div class="border-t-2 border-t-rose-800"></div>`;
      repr += `<div><code>${obj.goal}</code></div>`;
      if (obj.more > 0)
        repr += `<div class="font-sans text-sm mt-2">(+ ${obj.more} more subgoal${obj.more > 1 ? "s" : ""})</div>`;
      repr += '</div>';
      return repr;
    }
    const getStuff = async () => {
      let thm_file = await fetch('type-uniq.thm').then(resp => resp.text());
      let json_file = await fetch('type-uniq.json').then(resp => resp.json());
      // console.log(thm_file);
      // console.log(json_file);
      const thm_box = $('#thmbox');
      thm_box.empty();
      let last_pos = 0;
      json_file.forEach((elm) => {
        if (elm.provenance) {
          const [fn, [start], [stop]] = elm.provenance;
          // console.log(fn, start, stop);
          // console.log(thm_file.slice(start, stop));
          if (last_pos < start) {
            $(thm_box).append(`<span class="text-rose-900">${thm_file.slice(last_pos, start)}</span>`);
            last_pos = start;
          }
          $(thm_box).append(`<span data-count="${elm.count}" class="abella-command underline text-slate-800">${thm_file.slice(start, stop)}</span>`);
          last_pos = stop;
        }
      });
      // thm_box.html(thm_html);
      $('.abella-command').on('click', function () {
        // $(this).addClass('underline');
        // console.log($(this));
        const count = $(this).data('count');
        // console.log($(this).data('count'));
        const obj = json_file.find(elm => elm.count == count);
        if (obj) {
          let descr = "<div class=\"whitespace-pre font-mono text-sm overflow-auto\">";
          if (obj.type === "top_command") {
            descr += `Abella &lt; <strong>${obj.command}.</strong>`;
          } else {
            descr += `${seqToStr(obj.start_state)}\n`;
            descr += `${obj.theorem} &lt; <strong>${obj.command}.</strong>`;
            if (obj.end_state)
              descr += `\n\n${seqToStr(obj.end_state)}`;
          }
          descr += "</div>";
          const fb = Fancybox.show([
            { src: descr, type: "html" }
          ]);
        }
      });
    }
    getStuff();
  </script>
</body>

</html>