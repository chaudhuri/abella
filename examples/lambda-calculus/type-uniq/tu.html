<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Testing document</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css" />
</head>

<body>
  <div id="container" class="absolute inset-0">
    <div id="thmbox" class="font-mono bg-yellow-200 leading-tight w-full h-full px-5 whitespace-pre overflow-auto text-green-800">
      &nbsp;
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>
  <script>
    const bg = (count) => count & 1 === 1 ? "bg-slate-50" : "bg-slate-100";
    const seqToStr = (obj) => {
        let repr = '<div class="flex flex-col max-w-xl whitespace-normal ml-2 pl-2 border-l-2 border-l-rose-200">';
        if (obj.name && obj.name.length > 0) {
            repr += `<div><span class="mb-3 bg-rose-400 text-white p-1 font-sans text-xs">Subgoal ${obj.name}</span></div>`;
        }
        let count = 0;
        if (obj.vars && obj.vars.length > 0) {
            repr += `<div class="${bg(count++)}"><code>Variables: ${obj.vars.join(" ")}</code></div>`;
        }
        obj.hyps.forEach((h) => {
            repr += `<div class="${bg(count++)}"><code><span class="text-rose-600">${h[0]}</span>: ${h[1]}</code></div>`;
        });
        repr += `<div class="border-t-2 border-t-rose-800"></div>`;
        repr += `<div><code>${obj.goal}</code></div>`;
        if (obj.more > 0)
            repr += `<div class="font-sans mt-2">(+ ${obj.more} more subgoal${obj.more > 1 ? "s" : ""})</div>`;
        repr += '</div>';
        return repr;
    }
    const getStuff = async () => {
        const init = {
            method: 'GET',
            cache: 'no-store',
            headers: { pragma: 'no-cache' }
        };
        let thm_text = await fetch('type-uniq.thm', init).then(resp => resp.text());
        let run_data = await fetch('type-uniq.json', init).then(resp => resp.json());
        const thm_box = $('#thmbox');
        thm_box.empty();
        let last_pos = 0;
        run_data.forEach((elm) => {
            if (elm.range) {
                const [start, , , stop, , ] = elm.range;
                if (last_pos < start) {
                    $(thm_box).append(`${thm_text.slice(last_pos, start)}`);
                    last_pos = start;
                }
                const ul = elm.type === "proof_command" ? "text-rose-700 text-sm" : "leading-snug text-slate-800" ;
                $(thm_box).append(`<div data-id="${elm.id}" class="inline-block abella-command ${ul} cursor-default hover:shadow-md hover:shadow-rose-800/40 hover:bg-white">${thm_text.slice(start, stop)}</div>`);
                last_pos = stop;
            }
        });
        const flId = (obj) => 'info-' + $(obj).data('id');
        $('.abella-command').each(function () {
            const id = $(this).data('id');
            const obj = run_data.find(elm => elm.id === id);
            if (obj) {
                let descr = "<div class=\"whitespace-pre font-mono text-sm overflow-auto\">";
                if (obj.type === "top_command") {
                    descr += `Abella &lt; <strong>${$(this).text()}</strong>`;
                } else {
                    descr += `${seqToStr(obj.start_state)}\n`;
                    descr += `${obj.theorem} &lt; <strong>${$(this).text()}</strong>`;
                    if (obj.end_state)
                        descr += `\n\n${seqToStr(obj.end_state)}`;
                }
                descr += "</div>";
                flobj = $(`<div id="${flId(this)}" class="border-2 border-rose-800 bg-white p-2 shadow-lg shadow-rose-600/40">`);
                $(flobj).css({
                    'position': 'absolute',
                    'z-index': '10100',
                    'display': 'none'
                });
                $(flobj).html(descr);
                $('#container').append(flobj);
                // const fb = Fancybox.show([
                //   { src: descr, type: "html" }
                // ]);
            } else {
                console.error(`Could not find ${id}!`);
            }
        });
        $('.abella-command').on("mousemove", function (ev) {
            $('#' + flId(this)).css({
                'display': 'block',
                'top': ev.clientY + 10,
                'left': ev.clientX + 10
            });
        }).on("mouseleave", function () {
            $('#' + flId(this)).css({ 'display': 'none' });
        }).on("click", function () {
            const flid = '#' + flId(this);
            $(flid).css({ 'display': 'none' });
            Fancybox.show([ { src: $(flid).html(), type: "html" } ]);
        });
    }
    getStuff();
  </script>
</body>

</html>
